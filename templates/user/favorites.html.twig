{% extends 'base.html.twig' %}

{% block title %}My Favorites - Mentionable{% endblock %}

{% block body %}
    <div class="main-panel">
        <div class="content-wrapper p-0">
            <div class="row justify-content-center mb-4 pt-4">
                <div class="col-lg-8 p-3 justify-content-center">
                    <div class="d-flex flex-row justify-content-center">
                        <h1 class="text-center">
                            Favorite notes
                        </h1>
                        <span class="badge badge-light text-dark mt-2 ms-3" style="height: 25px">{{ notesCount }}</span>
                        {% if favoritesMap|length > 0 %}
                            <a href="{{ path('app_user_clear_favorites', {'id': app.user.id}) }}" style="height: 25px" class="mb-0 pb-0 mt-2 ms-2">
                                <span class="badge badge-light text-dark" style="height: 25px">
                                    Clear all
                                </span>
                            </a>
                        {% endif %}
                    </div>
                </div>
                {# ERROR MESSAGE #}
                {% for label, messages in app.flashes %}
                    {% for message in messages %}
                    <div class="row justify-content-center mb-4">
                        <div class="col-lg-8 col-12 alert alert-{{ label }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
                {# NOTES LIST #}
                <div class="row justify-content-center mb-4">
                    {# NOTE #}
                    {% if notes is defined %}
                        <div id="notes-container" class="d-flex flex-column align-items-center">
                            {% include 'default/_note.html.twig' with {
                                notes: notes,
                                votesMap: votesMap,
                                commentVotesMap: commentVotesMap,
                                favoritesMap: favoritesMap,
                                rolesMap: rolesMap,
                                limitedComments: limitedComments,
                            } %}
                        </div>
                    {% else %}
                        <div class="col-lg-7 pt-4 ps-4 pe-4" style="background-color: #181b20; border-radius: 5px; margin-top: 2rem;">
                            <p class="text-light">Oops. No notes available here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
{{ parent() }}
<script>
    window.votesMap = {{ votesMap|json_encode|raw }};
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll(".toggle-comments");

    buttons.forEach(button => {
        button.addEventListener("click", function () {
            const noteId = this.getAttribute("data-note-id");
            const commentSection = document.getElementById("comments-" + noteId);

            if (commentSection) {
                if (commentSection.style.display === "none" || commentSection.style.display === "") {
                    commentSection.style.display = "block";
                } else {
                    commentSection.style.display = "none";
                }
            } else {
                console.error("Nu s-a găsit elementul pentru comentarii cu id: comments-" + noteId);
            }
        });
    });
});
</script>
<script>
    window.commentVotesMap = {{ commentVotesMap|json_encode|raw }};
    window.currentUserNametag = "{{ app.user ? app.user.nametag : '' }}";
    window.csrfToken = "{{ csrf_token('comment_vote') }}";
</script>
<script>
document.getElementById('notes-container').addEventListener('click', function(e) {
    const link = e.target.closest('.see-all-comments');
    if (!link) return;

    e.preventDefault();
    const noteId = link.dataset.noteId;
    const commentsContainer = document.getElementById('comments-list-' + noteId);
    const url = '/note/' + noteId + '/comments';

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const commentsArray = Array.isArray(data) ? data : (data.comments || []);
            const existingIds = Array.from(commentsContainer.querySelectorAll('[data-comment-id]'))
                .map(el => el.dataset.commentId);

            commentsArray.forEach(comment => {
                if (!comment || !comment.user || !comment.id) return;
                if (!existingIds.includes(String(comment.id))) {
                    const isUpvoted = window.commentVotesMap && window.commentVotesMap[comment.id] === 'upvote';
                    const html = `
                        <div class="d-flex flex-row mb-3" data-note-id="${noteId}" data-comment-id="${comment.id}">
                            <a class="nav-link me-2" href="/profile/${comment.user.id}/view">
                                <img class="img-xs rounded-circle" src="/uploads/avatars/${comment.user.avatar}" alt="avatarComment" onerror="showDefaultIcon(this)">
                            </a>
                            <div class="ms-2 p-0">
                                <div class="d-flex flex-row" style="height: 30px;">
                                    <a class="m-0 p-0 text-decoration-none text-white" href="/profile/${comment.user.id}/view">
                                        <p class="text-white me-2" style="font-size: 18px;">@${comment.user.nametag}</p>
                                    </a>
                                    ${comment.isEdited ? `<i class="fa fa-clock-o text-gray me-1" style="margin-top: 6px"></i>` : `<p class="text-gray mt-1 me-2">•</p>`}
                                    <p class="text-gray mt-1">${comment.humanTime}</p>
                                </div>
                                <div class="d-inline-flex">
                                    <small style="font-size: 16px; color: #404040; background-color: #ffffff; border-radius: 8px; opacity: 0.9; padding: 5px;">${comment.message}</small>
                                    <button class="btn btn-sm ms-2 d-flex align-items-center border-0 comment-upvote-btn ${isUpvoted ? 'btn-light' : 'btn-outline-light'}"
                                            type="button"
                                            data-note-id="${noteId}"
                                            data-comment-id="${comment.id}"
                                            data-csrf="${window.csrfToken}">
                                        <i class='bx bx-arrow-up' style="font-size: 20px;"></i>
                                        <span id="comment-upvotes-${comment.id}" class="ms-1">${comment.upVote || 0}</span>
                                    </button>
                                </div>
                            </div>
                            <div class="dropdown ms-auto me-1 d-inline-flex justify-content-end">
                                <a href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="height: 30px;">
                                    <i class='bx bx-dots-horizontal-rounded' style='color:#ffffff'></i>
                                </a>
                                <ul class="dropdown-menu m-0">
                                    ${
                                        comment.user.nametag === window.currentUserNametag
                                        ? `<li><a class="dropdown-item" href="/post/comment/${noteId}-${comment.id}/update">Edit...</a></li>
                                           <li><a class="dropdown-item delete-comment-btn" href="/post/comment/${noteId}-${comment.id}/delete">Delete comment</a></li>`
                                        : `<li><a class="dropdown-item" href="/note/comment/${noteId}-${comment.id}/report">Report</a></li>`
                                    }
                                </ul>
                            </div>
                        </div>
                    `;
                    commentsContainer.insertAdjacentHTML('beforeend', html);
                }
            });

            link.style.display = 'none';
        })
        .catch(err => console.error('Error loading comments:', err));
});
</script>
<script src="{{ asset('../assets/js/feed.js') }}"></script>
<script src="{{ asset('../assets/js/comments.js') }}"></script>
<script src="{{ asset('../assets/js/favorite.js') }}"></script>
<script src="{{ asset('../assets/js/emoji.js') }}"></script>
{% endblock %}