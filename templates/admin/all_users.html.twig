{% extends 'base.html.twig' %}

{% block title %}All users - Admin - Mentionable{% endblock %}

{% block body %}
    <div class="main-panel">
        <div class="content-wrapper p-0">
            <div class="row justify-content-center mb-4 mt-2">
                <div class="col-lg-8 p-3 justify-content-center">
                    {% for message in app.flashes('success') %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                    {% for message in app.flashes('error') %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
                <div class="col-lg-8 p-3 justify-content-center">
                    <div class="d-flex flex-row justify-content-center">
                        <h1 class="text-center d-none d-md-flex">
                            Users
                        </h1>
                        <h1 class="text-center d-flex d-md-none mt-1" style="font-size: 24px">
                            Users
                        </h1>
                        <span class="badge badge-light text-dark mt-2 ms-2" style="height: 25px">{{ users|length }}</span>
                    </div>
                </div>
                <div class="col-lg-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th> Avatar </th>
                                        <th> Nametag </th>
                                        <th> Email </th>
                                        <th> Role </th>
                                        <th> Joined At </th>
                                        <th> Actions </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if users is defined and users is not empty %}
                                        {% for user in users %}
                                            <tr>
                                                <td class="py-1">
                                                    <img src="{{ asset('uploads/avatars/' ~ user.avatar) }}"
                                                         alt="Avatar"
                                                         class="img-fluid mt-1 mb-1"
                                                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 3px rgba(255,255,255,0.1);"
                                                         onerror="showDefaultUser(this)"/>
                                                </td>
                                                <td> {{ user.nametag }} </td>
                                                <td> {{ user.email }} </td>
                                                <td>
                                                    {% if 'ROLE_ADMIN' in user.roles %}
                                                        Admin{% if 'ROLE_USER' in user.roles %}, User{% endif %}
                                                    {% elseif 'ROLE_USER' in user.roles %}
                                                        User
                                                    {% else %}
                                                        <i class="text-danger">(no roles)</i>
                                                    {% endif %}
                                                </td>
                                                <td> {{ user.creationDate|date('d-m-Y') }} </td>
                                                <td>
                                                    <a href="#" data-bs-toggle="modal" data-bs-target="#userKickManagement{{ user.id }}" class="btn btn-warning">
                                                        <i class="fa fa-trash-o" style="color: white; font-size: 20px"></i>
                                                    </a>
                                                    <a href="#" data-bs-toggle="modal" data-bs-target="#userBanManagement{{ user.id }}" class="btn btn-danger">
                                                        <i class="fa fa-ban" style="color: white; font-size: 20px"></i>
                                                    </a>
                                                    {% if user.isBanned %}
                                                        <a href="#" data-bs-toggle="modal" data-bs-target="#userUnbanManagement{{ user.id }}" class="btn btn-success">
                                                            <i class="fa fa-check" style="color: white; font-size: 20px"></i> Unban
                                                        </a>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% for user in users %}
                <!-- Modal kick user management -->
                <div class="modal fade" id="userKickManagement{{ user.id }}" tabindex="-1" aria-labelledby="userKickManagementLabel{{ user.id }}">
                    <div class="modal-dialog" style="max-width: 850px;">
                        <div class="modal-content" style="background-color: #181b20; border-radius: 5px;">
                            <div class="modal-header bg-warning text-white">
                                <h5 class="modal-title" id="userKickManagementLabel{{ user.id }}">Confirm kicking the user {{ user.nametag }}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to kick this user? This action would result in deleting the user's account and they will be able to register back under the same credentials.
                            </div>
                            <div class="modal-footer">
                                <form method="post" id="deleteUserForm" action="{{ path('admin_user_kick', {'id': user.id}) }}">
                                    <input type="hidden" name="_token" value="{{ csrf_token('kick-user-' ~ user.id) }}">
                                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-warning">Kick</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal ban user management -->
                <div class="modal fade" id="userBanManagement{{ user.id }}" tabindex="-1" aria-labelledby="userBanManagementLabel{{ user.id }}">
                    <div class="modal-dialog" style="max-width: 850px;">
                        <div class="modal-content" style="background-color: #181b20; border-radius: 5px;">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="userBanManagementLabel{{ user.id }}">Confirm banning the user {{ user.nametag }}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to ban this user? This action would not delete the user's account but instead, it would result in suspending all the website's features for the user until further review from admins.
                            </div>
                            <div class="modal-footer">
                                <form method="post" id="banUserForm" action="{{ path('admin_user_ban', {'id': user.id}) }}">
                                    <input type="hidden" name="_token" value="{{ csrf_token('ban-user-' ~ user.id) }}">
                                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Ban</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal unban user management -->
                <div class="modal fade" id="userUnbanManagement{{ user.id }}" tabindex="-1" aria-labelledby="userUnbanManagementLabel{{ user.id }}">
                    <div class="modal-dialog" style="max-width: 850px;">
                        <div class="modal-content" style="background-color: #181b20; border-radius: 5px;">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="userUnbanManagementLabel{{ user.id }}">Confirm unbanning the user {{ user.nametag }}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to unban this user? This will restore the user's access to the website.
                            </div>
                            <div class="modal-footer">
                                <form method="post" action="{{ path('admin_user_unban', {'id': user.id}) }}">
                                    <input type="hidden" name="_token" value="{{ csrf_token('unban-user-' ~ user.id) }}">
                                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-success">Unban</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
{{ parent() }}
<script>
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hide.bs.modal', () => {
            const focused = document.activeElement;
            if (modal.contains(focused)) {
                focused.blur();
                document.body.focus();
            }
        });
    });
</script>
{% endblock %}